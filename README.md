# AnchorCDC를 사용한 Localization 최적화

## 프로젝트 요약

이 문서에서는 문자열 리소스(예: 게임 내 텍스트 키나 번역 문장)를 자동으로 나누어 여러 개의 C# 코드 파일로 출력하는 방식을 다룹니다.

기존의 키 이름이나 해시 값을 기준으로 일정한 규칙에 따라 그룹을 나누는 방식은 일부 상황에서 변경이 불필요하게 확산되는 문제가 발생합니다. 이를 해결하기 위해, 각 키에 대해 해시 기반 조건(anchor)을 적용하여 분할 지점을 결정하는 방식을 제안합니다.

## AnchorCDC 적용 후 기대사항

- **검토 파일 수 대폭 감소**  
  스냅샷 업데이트 당 파일이 평균 6.25개만 변경되어 기존 **Sharding**(평균 24개 변경) 대비 변경 파일 검토량을 약 **74% 절감**할 수 있습니다.

## 프로젝트 목적

본 프로젝트는 대규모 Localization 키 목록을 보다 효율적으로 관리하고, 빌드 성능 및 협업 과정에서의 유지보수성을 개선하기 위해 시작되었습니다.

기존에는 해시 기반의 정적 샤딩(sharding) 방식을 사용해 키를 분할했으나, 이로 인해 변경 범위가 불필요하게 확산되거나, 연관된 항목들이 서로 다른 파일에 분산되는 문제가 발생했습니다. 이에 따라, 보다 안정적이고 의미 단위에 가까운 분할이 가능하도록 개선된 청크 분할 전략 **AnchorCDC**를 설계·구현하게 되었습니다.

## 기존 구현(Sharding)

기존 구현은 **Sharding** 방식으로, 해시 값을 기준으로 문자열 키를 나누어 파일을 생성합니다. 이 방식은 엔트리 추가/수정/삭제 시 모든 파일에서 변경이 발생할 수 있어 불필요한 자원 소모가 발생하며, 변경 범위가 확산되는 문제가 있었습니다.  

이와 관련된 코드와 더 자세한 구현은 [`sharding.cs`](./sharding.cs) 파일에서 확인할 수 있습니다.

## 새로운 구현(AnchorCDC)

**AnchorCDC** 방식은, 각 키에 대해 해시 값을 계산하고 조건에 맞는 특정 지점을 기준으로 파일을 나누는 방식입니다. 이를 통해 연관된 키들이 동일한 파일에 묶이고, 변경 시 영향 범위가 제한됩니다. 또한, 이 방식은 불필요한 파일 변경을 줄여 효율성을 극대화할 수 있습니다.

AnchorCDC 방식의 구현은 [`AnchorCDC.cs`](./AnchorCDC.cs) 파일에서 확인할 수 있습니다.

### Anchor(앵커)의 정의

Anchor는 문자열 키 목록을 분할할 때, 청크(파일)를 나누는 기준점입니다. 각 키에 대해 해시 값을 계산한 뒤, 정해진 조건을 만족하는 경우 해당 키를 앵커로 간주하고, 이 지점을 기준으로 새 파일(청크)을 시작합니다.

예를 들어, `KEY_UI_START`, `KEY_UI_OPTIONS`, `KEY_UI_EXIT`처럼 UI 관련 키들이 연달아 있을 때, 특정 키(`KEY_UI_OPTIONS`)가 앵커로 판단되면, 그 이전 키들만 모아 하나의 파일로 저장하고, 이후 키들은 다음 파일로 넘어갑니다. 결과적으로 연관된 키들이 같은 파일에 묶이는 경향이 생기고, 변경 시 영향 범위도 제한됩니다.

### MinEntries 제한을 적용한 이유

- Maskbit로 Anchor를 판단하고 파일을 나누는 과정에서, Anchor가 나타날 때마다 파일을 나누게 되면 과도하게 작은 파일이 생길 수 있습니다. 과도하게 작은 파일의 존재는 Locale 변경 시 변경 범위에 파일의 Anchor가 포함되는 확률을 높여 파일 관리를 불편하게 만들 수 있으므로 MinEntries를 도입하여 특정 크기 이하의 파일이 생기지 않도록 방지합니다.

### MaxEntries 제한을 적용하지 않는 이유

- MinEntries의 경우와 달리, MaxEntries는 사용하지 않습니다. MaxEntries를 사용할 경우, Anchor가 희박하게 나타나는 상황에서 Anchor가 아닌 지점에서 강제로 파일이 잘리는 경우가 생기게 됩니다. 즉, 모든 파일의 분류가 항상 Anchor에서 일어난다고 보장할 수 없게 되므로, 이를 방지하기 위해 MaxEntries는 도입하지 않습니다.

## 결론

AnchorCDC 방식은 해시 기반의 분할이 아닌, 의미 단위에 가까운 분할을 통해 파일 변경 범위를 효율적으로 관리할 수 있는 방법입니다. 이를 통해 대규모 Localization 파일의 관리 및 빌드 성능을 향상시킬 수 있습니다.
